# AGENTS.md — techsync-gen-ai リポジトリ向けエージェントガイド

このファイルは、このリポジトリで作業するエージェント（LLM 等）のためのガイドラインです。  
特にコード変更・ドキュメント整備・デバッグを行う際の方針を示します。

---

## 全体方針

- このリポジトリは **社内向け Slack QA Bot（RAG）** プロジェクトです。
- ドキュメントや説明文は **日本語** を優先してください。
- 修正は「最小限で本質的なもの」を心がけ、不要なリファクタや大規模改変は行わないでください。
- 機密情報（APIキー、トークン、パスワードなど）を **新たにコードやドキュメントへ書き込まない** でください。
- 作業前に、対象ディレクトリの `SKILLS.md` に軽く目を通し、そのディレクトリ固有の方針を把握してください。

---

## 実行・検証方法（推奨フロー）

1. **起動**
   - `docker compose up -d --build`
   - モデルが未 pull の場合は、`ollama` コンテナ内で `ollama pull モデル名` を実行する。
2. **インデックス作成 / 更新**
   - `docker compose exec app python ingest_docs.py`
3. **簡易動作確認（コード側の変更を検証）**
   - `docker compose exec app python query_test.py`
   - もしくは、Slack 上で Bot にメンションして応答を確認する。

- テストや検証用のスクリプトを新規追加する場合は、**最小限** に留め、不要になったものは削除するか明示的に `docs/` などへ移動してください。

---

## コードスタイル・設計方針

### Python（`app/` 配下）

- 既存コードのスタイルに合わせること。
  - 関数名・変数名は `snake_case`。
  - 型ヒントは既存の書き方に合わせて使用（無理に全面導入しない）。
  - ログやエラーメッセージは **日本語** を優先。
- 新規関数を追加する際は、できるだけ **1つの責務に絞る** こと。
- 例外処理
  - ユーザー向けにはスタックトレースではなく **日本語メッセージ** を返す。
  - ログには例外内容がわかるようなメッセージを `print` で残してよい。
- RAG・LLM 周り
  - `ingest_docs.py`
    - `docs/` 以下のファイルをチャンク分割し、Ollama embeddings API でベクトル化する既存の流れを尊重すること。
    - モデルの制約でエラーが発生し得る箇所（長文入力など）については、**フォールバックや分割処理** の改善は歓迎。
  - `main.py`
    - 検索ロジック（キーワード + ベクトル検索）の振る舞いを大きく変える場合は、コメントで意図を明記すること。
    - Slack とのインタラクション（スレッド、会話履歴、長文送信など）を変更する際は、ユーザー体験が悪化しないよう慎重に。
    - LLM 呼び出しパラメータ（`LLM_MODEL` / `LLM_NUM_PREDICT` 等）を変更した場合は、`.env.example` と `README.md` を更新する。

---

## ドキュメント方針

- `README.md` は、このリポジトリの **正確な実装状態** と手順を反映させるように維持してください。
  - モデル名や環境変数のデフォルト値・意味を変更した場合は README も更新する。
  - 実行手順に変更が出る場合（新しいコマンドの追加など）は、README への追記を行う。
- `docs/` 配下は **RAG のインデックス対象** です。
  - 実運用を想定したドキュメントを置く。
  - テスト用・ダミーのドキュメントを追加する場合は、ファイル名や本文にテスト用途であることを明記する。

---

## 変更に関する注意点

- 既存のテーブル定義（`sql/init.sql`）や `VECTOR` 次元数を変更する場合は、**必ず理由をコメント** に残してください。
  - 併せて `sql/SKILLS.md` と `app/SKILLS.md` を見て、アプリ側への影響（再インデックス、環境変数）も確認する。
- `.env` / `.env.example` に変更を加える場合は:
  - 新しい環境変数の意味と使い方を README に反映する。
  - 秘匿情報のサンプル値はダミーにする（実値は書かない）。
- 不要なファイルの削除や大規模リネームは、ユーザーの明示的な指示がない限り行わないでください。

---

## エージェントへのお願い（効率的に動くために）

- 作業の前に
  - 触る予定のディレクトリの `SKILLS.md` を確認し、その範囲で何が得意か・注意点は何かを把握してください。
  - 既存の実装方針と大きく異なる案が思いついた場合は、まずは「現実的な最小変更」で解決できないか検討してください。
- 変更時
  - わからない点がある場合や仕様が曖昧な場合は、**推測で書き換えず、コメントや README に TODO や前提を明記する** 形で対応してください。
  - 変更内容はできるだけ局所的に留め、関連しない部分には手を入れないでください。
- 変更後
  - 可能な範囲で `query_test.py` や Slack 上での動作確認を行い、RAG と LLM の挙動が意図通りか確認してください。
  - もし他のエージェントや人間開発者に対して有用な知見（ハマりポイント、注意点など）を得た場合は、この `AGENTS.md` や各ディレクトリの `SKILLS.md` に追記して構いません。
